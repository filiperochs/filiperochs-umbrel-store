services:
  # app_proxy:
  #   environment:
  #     APP_HOST: filiperochs-spacebarchat-server_server_1
  #     APP_PORT: 5235
  #     PROXY_AUTH_ADD: "false"

  server:
    image: filiperochs/spacebarchat-server
    container_name: filiperochs-spacebarchat-server_server_1
    restart: unless-stopped
    ports:
      - "5235:5235"
    # monta o storage usado pela imagem oficial
    volumes:
      - ${APP_DATA_DIR}/storage:/exec/persistent/storage
      - ${APP_DATA_DIR}/data:/spacebar
    environment:
      - PORT=5235
      # conex√£o com Postgres (service name = db)
      - DATABASE=postgres://${POSTGRES_USER:-spacebar}:${POSTGRES_PASSWORD:-spacebar}@db:5432/${POSTGRES_DATABASE:-spacebar}
      - STORAGE_PROVIDER=file
      - STORAGE_LOCATION=/exec/persistent/storage/
    networks:
      - filiperochs_spacebarchat_server_network
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-spacebar}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-spacebar}
      - POSTGRES_DB=${POSTGRES_DATABASE:-spacebar}
    volumes:
      - ${APP_DATA_DIR}/postgres:/var/lib/postgresql/data
    networks:
      - filiperochs_spacebarchat_server_network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-spacebar} -d ${POSTGRES_DATABASE:-spacebar}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  filiperochs_spacebarchat_server_network:
    driver: bridge
