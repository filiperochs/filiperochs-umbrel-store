# n8n - Automação de workflows para Umbrel
# Documentação: https://docs.n8n.io/hosting/installation/docker/
# Repo oficial: https://github.com/n8n-io/n8n-hosting
#
# Para personalizar: defina no ambiente ou .env (onde o Umbrel executar):
#   N8N_ENCRYPTION_KEY=chave_base64_32_chars  (recomendado em produção)
#   N8N_DB_PASSWORD=senha_postgres
#   TZ=America/Sao_Paulo

version: "3.9"

services:
  # Proxy Umbrel - encaminha tráfego para o container do n8n
  app_proxy:
    environment:
      APP_HOST: filiperochs-n8n_n8n_1
      APP_PORT: 5678
      PROXY_AUTH_ADD: "false"

  # PostgreSQL - banco de dados para workflows e credenciais do n8n
  # Doc: https://docs.n8n.io/hosting/installation/docker/#using-with-postgresql
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: ${N8N_DB_PASSWORD:-n8n_umbrel_db}
      POSTGRES_DB: n8n
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n -d n8n"]
      interval: 5s
      timeout: 5s
      retries: 5

  # n8n - plataforma de automação de workflows
  # Doc: https://docs.n8n.io/hosting/installation/docker/
  n8n:
    image: n8nio/n8n:latest
    container_name: filiperochs-n8n_n8n_1
    user: "1000:1000"
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - TZ=${TZ:-UTC}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-UTC}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=true
      # PostgreSQL (host = nome do serviço na rede Docker)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD:-n8n_umbrel_db}
      - DB_POSTGRESDB_SCHEMA=public
      # Chave de criptografia para credenciais; em produção defina N8N_ENCRYPTION_KEY
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-n8n_umbrel_encryption_key_change_in_prod}
    volumes:
      - ${APP_DATA_DIR}/data/n8n:/home/node/.n8n
